### Testing cryo-FIB custom milling ### 

### User Input ###
output_dir=r'D:/SharedData/Sven/20220331_Waffle/Automation/Try3/'

patternfile_trench=r'D:/SharedData/Sven/20210805_WaffleDev/patternfiles/TopCut3.pf'

patternfile_nodge=r'D:/SharedData/Sven/20210805_WaffleDev/patternfiles/nodge.pf'

lamella_protocol=r'D:/SharedData/Sven/20210805_WaffleDev/patternfiles/lamellamill.pro'

fibsem.alignment_current=50e-12

img_index_trench=7
stagepos_index_trench=0
pattern_index_trench=7

img_index_nodge=1
stagepos_index_nodge=1
pattern_index_nodge=1

img_index_lamella=2
stagepos_index_lamella=1
pattern_index_lamella=2

#############


#### Initial Trench from Above ####

### Definition of variables ###

fibsem.output_dir=output_dir+'/'
label=stagepositions[stagepos_index_trench]['label']
alignment_image=images[img_index_trench]
pattern_dir=output_dir+'/'+str(label)+'/'
stagepos=stagepositions[stagepos_index_trench]

fibsem.write_patterns(label,patterns[pattern_index_trench],alignment_image,output_dir)


#fibsem.run_milling_custom(label,alignment_image,stagepos,pattern_dir,patternfile_trench)


#### Nodge Milling ####

label=stagepositions[stagepos_index_nodge]['label']
alignment_image=images[img_index_nodge]
pattern_dir=output_dir+'/'+str(label)+'/'
stagepos=stagepositions[stagepos_index_nodge]

fibsem.write_patterns(label,patterns[pattern_index_nodge],alignment_image,output_dir)

fibsem.run_milling_custom(label,alignment_image,stagepos,pattern_dir,patternfile_nodge)



#### Lamella Milling ####



#############

### Definition of variables ###

fibsem.output_dir=output_dir+'/'
label=stagepositions[stagepos_index_lamella]['label']
alignment_image=images[img_index_lamella]
pattern_dir=output_dir+'/'+str(label)+'/'
stagepos=stagepositions[stagepos_index_lamella]

#print(patterns)
fibsem.write_patterns(label,patterns[pattern_index_lamella],alignment_image,output_dir)


### Creating patternfile ###



fibsem.run_milling_protocol(label,alignment_image,stagepos,pattern_dir,lamella_protocol)
